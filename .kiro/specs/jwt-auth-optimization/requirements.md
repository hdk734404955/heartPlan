# JWT认证优化需求文档

## 介绍

针对HeartPlan约会应用的JWT认证系统进行优化，简化认证流程，提高安全性和性能。当前系统存在过度复杂的设计，需要简化为适合约会应用的简单登录认证机制。

## 需求

### 需求1：简化JWT令牌结构

**用户故事：** 作为系统开发者，我希望JWT令牌结构更简洁，以便提高性能和减少复杂性

#### 验收标准

1. 当生成JWT令牌时，系统应该只包含必要的用户标识信息（邮箱）
2. 当生成JWT令牌时，系统不应该在令牌中包含完整的用户信息
3. 当验证JWT令牌时，系统应该通过邮箱从数据库获取最新的用户信息
4. 当JWT令牌过期时，系统应该返回明确的过期错误信息

### 需求2：优化认证过滤器逻辑

**用户故事：** 作为系统开发者，我希望认证过滤器逻辑更简单直接，以便提高系统性能

#### 验收标准

1. 当请求包含有效JWT令牌时，系统应该直接通过邮箱加载用户信息
2. 当JWT令牌无效时，系统应该清除认证上下文并继续过滤器链
3. 当认证失败时，系统不应该尝试多种认证方式
4. 当用户被禁用时，系统应该拒绝认证并返回相应错误

### 需求3：规范JWT令牌类型管理

**用户故事：** 作为约会应用用户，我需要访问令牌和刷新令牌的完整功能来保持登录状态

#### 验收标准

1. 当系统设计时，应该保留访问令牌和刷新令牌的双令牌机制
2. 当系统设计时，不应该在JWT中存储完整用户信息，只存储邮箱
3. 当用户认证时，系统应该只验证用户是否登录，不需要角色权限
4. 当刷新令牌使用时，系统应该能够正确识别令牌类型并生成新的访问令牌

### 需求4：规范用户标识符的企业级处理

**用户故事：** 作为系统开发者，我希望按照Spring Security最佳实践正确处理用户标识符

#### 验收标准

1. 当实现UserDetails接口时，getUsername()方法应该返回用于认证的唯一标识符（邮箱），因为邮箱是用户登录时使用的凭证
2. 当JWT令牌中存储用户标识时，应该使用邮箱作为subject，保持与认证标识符一致
3. 当用户登录时，系统应该通过email查找用户，Spring Security使用email作为认证的用户名
4. 当需要获取用户的显示名称时，应该通过UserDetails对象的其他属性获取，而getUsername()返回认证标识符

### 需求5：简化JWT配置和异常处理

**用户故事：** 作为系统管理员，我希望JWT配置简单明了，异常处理统一规范

#### 验收标准

1. 当JWT配置时，系统应该只保留必要的配置项
2. 当JWT验证失败时，系统应该返回统一格式的错误响应
3. 当JWT过期时，系统应该提供明确的错误信息
4. 当JWT签名无效时，系统应该记录安全日志并拒绝访问

### 需求6：性能优化

**用户故事：** 作为约会应用用户，我希望登录和认证过程快速响应

#### 验收标准

1. 当用户频繁请求时，系统应该避免重复的数据库查询
2. 当JWT令牌验证时，系统应该使用高效的验证算法
3. 当用户信息加载时，系统应该只查询必要的字段
4. 当认证失败时，系统应该快速返回错误响应，不进行额外处理
### 需求7：企业级UserDetailsService实现

**用户故事：** 作为系统开发者，我希望UserDetailsService按照Spring Security标准实现用户加载逻辑

#### 验收标准

1. 当Spring Security调用loadUserByUsername时，参数应该是用户的邮箱
2. 当JWT令牌验证时，系统应该从令牌中提取邮箱，然后通过邮箱查找用户进行Spring Security认证
3. 当用户认证成功后，SecurityContext中应该存储完整的UserDetails对象，其中getUsername()返回用户邮箱
4. 当系统需要获取当前用户ID时，应该通过UserDetails对象的getId()方法或类似属性获取